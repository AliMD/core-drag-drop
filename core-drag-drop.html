<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">

<style>
  core-drag-avatar {
    position: fixed;
    left: 0;
    top: 0;
    display: block;
    width: 40px;
    height: 40px;
    border: 3px solid orange;
    pointer-events: none;
    background-color: whitesmoke;
  }
</style>

<!--
@group Polymer Core Elements
@element core-drag-drop
@homepage github.io
-->

<polymer-element name="core-drag-drop">
<script>

  Polymer('core-drag-drop', {
    observe: {
      'x y': 'coordinatesChanged'
    },

    ready: function() {
      this.avatar = document.createElement('core-drag-avatar');
      document.body.appendChild(this.avatar);
      this.showAvatar = false;
    },

    showAvatarChanged: function() {
      this.avatar.style.display = this.showAvatar ? '' : 'none';
    },

    coordinatesChanged: function() {
      var x = this.x - 20 + 64, y = this.y - 20 + 64;
      this.avatar.style.transform = this.avatar.style.webkitTransform = 'translate(' + x + 'px, ' + y + 'px)';
      //this.avatar.style.left = this.x + 'px';
      //this.avatar.style.top = this.y + 'px';
    },

    attached: function() {
      var listen = function(event, handler) {
        this.parentNode.addEventListener(event, this[handler].bind(this));
      }.bind(this);
      //
      listen('trackstart', 'trackStart');
      listen('track', 'track');
      listen('trackend', 'trackEnd');
      //
      var host = this.parentNode.host || this.parentNode;
      host.setAttribute('touch-action', 'none');
      host.style.cssText += '; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;';
    },

    trackStart: function(event) {
      console.log('[%s]: trackStart', this.localName);
      var event = this.fire('drag-start', {
        target: event.target,
        avatar: this.avatar
      });
      this.showAvatar = event.detail.drag;
    },

    track: function(event) {
      console.log('[%s]: track', this.localName);
      if (this.showAvatar) {
        this.x = event.pageX;
        this.y = event.pageY;
        this.fire('drag', {
          x: this.x,
          y: this.y,
          avatar: this.avatar
        });
      }
    },

    trackEnd: function() {
      console.log('[%s]: trackEnd', this.localName);
      if (this.showAvatar) {
        this.showAvatar = false;
        this.fire('drag-drop', {
          target: event.relatedTarget,
          avatar: this.avatar,
          framed: this.framed(event.relatedTarget)
        });
      }
    },

    framed: function(node) {
      var local = node.getBoundingClientRect();
      return {x: this.x - local.left, y: this.y - local.top};
    }

  });

</script>
</polymer-element>
